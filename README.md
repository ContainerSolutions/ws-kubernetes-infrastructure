---
title: Kubernetes Workshop Infrastructure
---

Kubernetes workshop infrastructure
==================================

> Create Kubernetes cluster on GCE using the default `kube-up.sh` process. A list of users is
generated by the script with a random password. By default RBAC is also automatically setup
per user to access the container registry and everything inside their own namespace.



## Install

This script should be run from the console on the GCP project where you want to have the cluster
running on.

The machine from which you run the scripts must have access to the appropriate Google APIs (compute, datastore?)

The list of users/password and the CA certificate will be displayed after the installation.

Copy the `install.sh` `config.sh` and `rbac.yaml` files into the machine and run the installation script:

```
$ ./install.sh
```

The amount of user can be overriden by passing the `USER_COUNT` environment variable:

```
$ USER_COUNT=30 ./install.sh
```

See the `config.sh` file for other options.


## Usage

### User authentication

You should share the CA certificate key and the cluster endpoint with all the students and
share the user name which is displayed at the end of the installation.

Then ask them to run the following command to access the cluster:

```
$ kubectl config set-cluster workshop-cluster \
   --server=https://1.2.3.4 \
   --certificate-authority=/path/to/ca.pem

$ kubectl config use-context workshop-cluster
```


### In-cluster container registry

The container registry addon is enabled, anyone can port-forward the service:

```
kubectl port-forward $(kubectl get po -n kube-system -l k8s-app=kube-registry-upstream -o jsonpath='{.items[0].metadata.name}') -n kube-system 5000
```

and push images using the following command:

```
docker push localhost:5000/user/container:v1.0.0
```

Note: when using macOS, you need to add `docker.for.mac.localhost:5000` to the list of unsecure
registry via the Docker preference panel. Then push the image to
`docker.for.mac.localhost:5000/user/container:v1.0.0`. See [issue comment](https://github.com/docker/for-mac/issues/1160#issuecomment-325872266).


Then use the `localhost:5000` as registry in any pod definition:

```
image: localhost:5000/user/container:v1.0.0
```

More information about the registry can be found [here](https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/registry#using-the-registry).


## Cleaning up

To shutdown the cluster and all the previously installed components:

```
$ ./destroy.sh
```

## Known issues


#### Basic auth doesn't work

If you need to add a new user or if you make any change to the `/etc/srv/kubernetes/basic_auth.csv` file,
you need to manually restart the apiserver pod because `kube-up.sh` doesn't create a replicaset:

```
gcloud compute ssh kubernetes-master --zone europe-west1-c \
  --command "docker ps | grep k8s_kube-apiserver | cut -f1 -d ' ' | xargs docker restart"
```

#### Kube-registry cannot find PVC

If for some reason the `kube-registry-pvc` isn't created, create it yourself:

```
$ cat <<EOF | kubectl apply -f -
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: kube-registry-pvc
  namespace: kube-system
  labels:
    kubernetes.io/cluster-service: "true"
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 200Gi
EOF
```

#### Cannot pull images from kube-registry

Registry DaemonSet is missing, add it yourself:

```
$ cat <<EOF | kubectl apply -f
apiVersion: extensions/v1beta1
kind: DaemonSet
metadata:
  name: kube-registry-proxy
  namespace: kube-system
  labels:
    k8s-app: kube-registry-proxy
    kubernetes.io/cluster-service: "true"
    version: v0.4
spec:
  template:
    metadata:
      labels:
        k8s-app: kube-registry-proxy
        kubernetes.io/name: "kube-registry-proxy"
        kubernetes.io/cluster-service: "true"
        version: v0.4
    spec:
      containers:
      - name: kube-registry-proxy
        image: gcr.io/google_containers/kube-registry-proxy:0.4
        resources:
          limits:
            cpu: 100m
            memory: 50Mi
        env:
        - name: REGISTRY_HOST
          value: kube-registry.kube-system.svc.cluster.local
        - name: REGISTRY_PORT
          value: "5000"
        ports:
        - name: registry
          containerPort: 80
          hostPort: 5000
EOF
```
